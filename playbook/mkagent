#!/bin/sh
export ANSIBLE_HOST_KEY_CHECKING=False

zone=deadsimplecloud.com

if [[ -z $NAME ]]; then
echo "You must set the NAME for the agent. e.g. <NAME>.$zone"
exit 1
fi

if [[ -z $IMAGE ]]; then
echo "You must set IMAGE for what Docker image to preload"
exit 1
fi

if [[ -z $SECRET ]]; then
echo "You must set SECRET for api authentication"
exit 1
fi

if [[ ! -z $ANSIBLE_PRIVATE_KEY_FILE ]]; then
  echo "chmod 400 $ANSIBLE_PRIVATE_KEY_FILE"
  chmod 400 $ANSIBLE_PRIVATE_KEY_FILE
fi

cat <<EOF > .dynamic_agents
[agents]
$IP name=$NAME secret=$SECRET
EOF
ansible-playbook -i .dynamic_agents site.yml
